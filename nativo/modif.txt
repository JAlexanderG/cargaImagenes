Option Explicit
Dim cn As ADODB.Connection
Dim rs As ADODB.Recordset

' Función pública mejorada para ajustar la longitud de la imagen
Public Function GuardarImagenDesdeSQL(ByVal codigo As String, ByVal id As String) As String
    On Error GoTo ManejoDeErrores ' Manejo de errores

    Dim rutaSalida As String
    Dim arrImagen() As Byte
    Dim archivo As Integer
    Dim sqlQuery As String
    Dim tamanoImagen As Long
    Dim tamanoOriginal As Long

    ' Crear conexión con SQL Server
    Set cn = New ADODB.Connection
    cn.ConnectionString = "Provider=SQLOLEDB;Data Source=SERVIDOR_SQL;Initial Catalog=BASE_DATOS;User ID=USUARIO;Password=CONTRASEÑA;"
    cn.Open

    ' Construir consulta con parámetros dinámicos
    sqlQuery = "SELECT imagen FROM TablaImagenes WHERE codigo = '" & codigo & "' AND id = '" & id & "'"

    ' Ejecutar consulta
    Set rs = New ADODB.Recordset
    rs.Open sqlQuery, cn, adOpenStatic, adLockReadOnly

    ' Verificar si hay una imagen
    If Not rs.EOF Then
        ' Obtener datos binarios de la imagen
        arrImagen = rs!imagen
        tamanoImagen = UBound(arrImagen) - LBound(arrImagen) + 1

        ' Asignar el tamaño esperado (según la imagen original)
        tamanoOriginal = 2404 ' <-- Aquí ajustamos el tamaño correcto que detectamos en la imagen válida

        ' Si la imagen es más grande, la recortamos al tamaño correcto
        If tamanoImagen > tamanoOriginal Then
            ReDim Preserve arrImagen(tamanoOriginal - 1)
        End If

        ' Definir ruta de salida
        rutaSalida = "C:\Temp\Imagen_" & codigo & "_" & id & ".bmp"

        ' Guardar archivo en disco correctamente
        archivo = FreeFile
        Open rutaSalida For Binary As archivo
        Put archivo, , arrImagen
        Close archivo

        ' Cerrar conexiones
        rs.Close
        cn.Close
        Set rs = Nothing
        Set cn = Nothing

        ' Retornar éxito con la ruta de la imagen guardada
        GuardarImagenDesdeSQL = "Imagen guardada en " & rutaSalida
        Exit Function
    Else
        ' No se encontró la imagen
        GuardarImagenDesdeSQL = "No se encontró la imagen con el código: " & codigo & " y ID: " & id
    End If

    ' Cerrar conexiones
    rs.Close
    cn.Close
    Set rs = Nothing
    Set cn = Nothing
    Exit Function

ManejoDeErrores:
    ' En caso de error, retornar el mensaje del error
    GuardarImagenDesdeSQL = "Error: " & Err.Description
End Function
