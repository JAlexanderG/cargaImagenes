Option Explicit
Dim cn As ADODB.Connection
Dim rs As ADODB.Recordset

Sub GuardarImagenDesdeSQL(codigo As String, id As String)
    Dim rutaSalida As String
    Dim arrImagen() As Byte
    Dim archivo As Integer
    Dim sqlQuery As String

    ' Crear conexión con SQL Server
    Set cn = New ADODB.Connection
    cn.ConnectionString = "Provider=SQLOLEDB;Data Source=SERVIDOR_SQL;Initial Catalog=BASE_DATOS;User ID=USUARIO;Password=CONTRASEÑA;"
    cn.Open

    ' Construir consulta con parámetros dinámicos
    sqlQuery = "SELECT imagen FROM TablaImagenes WHERE codigo = '" & codigo & "' AND id = '" & id & "'"

    ' Ejecutar consulta
    Set rs = New ADODB.Recordset
    rs.Open sqlQuery, cn, adOpenStatic, adLockReadOnly

    ' Verificar si hay una imagen
    If Not rs.EOF Then
        ' Obtener datos binarios de la imagen
        arrImagen = rs!imagen

        ' Definir ruta de salida
        rutaSalida = "C:\Temp\Imagen_" & codigo & "_" & id & ".bmp"

        ' Guardar archivo en disco
        archivo = FreeFile
        Open rutaSalida For Binary As archivo
        Put archivo, , arrImagen
        Close archivo

        ' Mensaje de confirmación
        MsgBox "Imagen guardada en: " & rutaSalida, vbInformation, "Éxito"
    Else
        MsgBox "No se encontró una imagen con el código: " & codigo & " y ID: " & id, vbExclamation, "Aviso"
    End If

    ' Cerrar conexiones
    rs.Close
    cn.Close
    Set rs = Nothing
    Set cn = Nothing
End Sub
