Private conn As ADODB.Connection

Function obtenerImg() As String
    Dim SqlStr As String
    Dim rs_sign As ADODB.Recordset
    Dim imageData As Variant
    Dim filePath As String
    Dim fileNum As Integer
    Dim dataBytes() As Byte

    On Error GoTo PROC_ERR

    ' Verificar y abrir la conexi칩n si es necesario
    If conn Is Nothing Or conn.State = adStateClosed Then
        If AbrirConexion() <> "OK" Then
            obtenerImg = "Error al conectar con la base de datos."
            Exit Function
        End If
    End If

    ' Definir la consulta SQL
    SqlStr = "SELECT campo FROM tabla WHERE codigo = '3423' AND id='342342'"

    ' Crear el Recordset y ejecutar la consulta
    Set rs_sign = New ADODB.Recordset
    rs_sign.Open SqlStr, conn, adOpenKeySet, adLockOptimistic

    ' Verificar si hay datos en la consulta
    If Not rs_sign.EOF Then
        imageData = rs_sign.Fields("campo").Value ' Obtener la imagen del campo

        ' Validar que no sea NULL y que realmente sea un array de bytes
        If Not IsNull(imageData) Then
            If VarType(imageData) = vbArray + vbByte Then
                dataBytes = imageData
            Else
                obtenerImg = "El campo no contiene datos binarios v치lidos."
                Exit Function
            End If
            
            ' Definir la ruta donde se guardar치 la imagen
            filePath = "C:\Temp\imagen_prueba.bmp"

            ' Asegurar que el directorio existe
            If Dir("C:\Temp", vbDirectory) = "" Then
                MkDir "C:\Temp"
            End If

            ' Guardar la imagen en disco
            fileNum = FreeFile
            Open filePath For Binary Access Write As #fileNum
            Put #fileNum, , dataBytes
            Close #fileNum

            obtenerImg = "Imagen guardada en: " & filePath
        Else
            obtenerImg = "No se encontr칩 la imagen en la base de datos."
        End If
    Else
        obtenerImg = "Registro no encontrado."
    End If

    ' Cerrar Recordset
    rs_sign.Close
    Set rs_sign = Nothing
    Exit Function

PROC_ERR:
    obtenerImg = "Error al obtener la imagen: " & Err.Description
    Exit Function
End Function
