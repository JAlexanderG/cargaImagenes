Private conn As ADODB.Connection

Function obtenerImg() As String
    Dim SqlStr As String
    Dim rs_sign As ADODB.Recordset
    Dim imageData As Variant
    Dim filePath As String
    Dim fileNum As Integer
    Dim dataBytes() As Byte

    On Error GoTo PROC_ERR

    ' Verificar y abrir la conexión si es necesario
    If conn Is Nothing Or conn.State = adStateClosed Then
        If AbrirConexion() <> "OK" Then
            obtenerImg = "Error al conectar con la base de datos."
            Exit Function
        End If
    End If

    ' Definir la consulta SQL
    SqlStr = "SELECT campo FROM tabla WHERE codigo = '3423' AND id='342342'"

    ' Crear el Recordset y ejecutar la consulta
    Set rs_sign = New ADODB.Recordset
    rs_sign.Open SqlStr, conn, adOpenKeySet, adLockOptimistic

    ' Verificar si hay datos en la consulta
    If Not rs_sign.EOF Then
        imageData = rs_sign.Fields("campo").Value ' Obtener la imagen del campo

        ' Convertir los datos a array de bytes si no es NULL
        If Not IsNull(imageData) Then
            dataBytes = imageData
            
            ' Definir la ruta donde se guardará la imagen
            filePath = "C:\Temp\imagen_prueba.bmp"

            ' Guardar la imagen en disco
            fileNum = FreeFile
            Open filePath For Binary As #fileNum
            Put #fileNum, , dataBytes
            Close #fileNum

            obtenerImg = "Imagen guardada en: " & filePath
        Else
            obtenerImg = "No se encontró la imagen en la base de datos."
        End If
    Else
        obtenerImg = "Registro no encontrado."
    End If

    ' Cerrar Recordset
    rs_sign.Close
    Set rs_sign = Nothing
    Exit Function

PROC_ERR:
    obtenerImg = "Error al obtener la imagen: " & Err.Description
    Exit Function
End Function
