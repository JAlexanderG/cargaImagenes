Option Explicit

Public Function GuardarImagenDesdeDB(ByVal recordId As Integer) As String
    On Error GoTo ErrHandler
    
    Dim conn As Object ' ADODB.Connection
    Dim rs As Object   ' ADODB.Recordset
    Dim imageData As Variant
    Dim filePath As String
    Dim fileNum As Integer
    Dim dataBytes() As Byte

    ' Intentar abrir la conexi칩n usando la funci칩n existente
    If AbrirConexion() <> "OK" Then
        GuardarImagenDesdeDB = "Error al conectar con la base de datos."
        Exit Function
    End If

    ' Crear el objeto Recordset
    Set rs = CreateObject("ADODB.Recordset")

    ' Ejecutar la consulta para obtener la imagen
    rs.Open "SELECT ImageData FROM SourceTable WHERE Id = " & recordId, Conn, 1, 3 ' adOpenKeyset, adLockOptimistic

    ' Verificar si hay datos
    If Not rs.EOF Then
        imageData = rs.Fields("ImageData").Value ' Obtener los datos binarios

        ' Convertir a un array de bytes si no lo es
        If Not IsNull(imageData) Then
            dataBytes = imageData
            
            ' Ruta donde se guardar치 la imagen en Mis Documentos
            filePath = Environ("USERPROFILE") & "\Documents\imagen_prueba.bmp"
            
            ' Guardar el archivo en disco
            fileNum = FreeFile
            Open filePath For Binary As #fileNum
            Put #fileNum, , dataBytes
            Close #fileNum

            GuardarImagenDesdeDB = "Imagen guardada en: " & filePath
        Else
            GuardarImagenDesdeDB = "No se encontr칩 la imagen en la base de datos."
        End If
    Else
        GuardarImagenDesdeDB = "Registro no encontrado."
    End If

    ' Cerrar el Recordset
    rs.Close
    Set rs = Nothing
    Exit Function

ErrHandler:
    GuardarImagenDesdeDB = "Error al obtener la imagen."
    Exit Function
End Function
