private byte[] EnsureMaxSize(Bitmap image, int maxDataSize, int maxFileSize)
{
    int width = image.Width;
    int height = image.Height;
    const int bmpHeaderSize = 54;

    while (true)
    {
        using (var ms = new MemoryStream())
        {
            image.Save(ms, ImageFormat.Bmp);
            byte[] imageData = ms.ToArray();
            int dataSize = imageData.Length - bmpHeaderSize;

            if (imageData.Length <= maxFileSize && dataSize <= maxDataSize)
                return imageData;
        }

        if (width < 100 || height < 100)
        {
            Console.WriteLine("⚠️ La imagen no puede reducirse más sin perder contenido.");
            break;
        }

        width = (int)(width * 0.90);
        height = (int)(height * 0.90);

        using (var resizedImage = new Bitmap(width, height))
        using (Graphics g = Graphics.FromImage(resizedImage))
        {
            g.InterpolationMode = System.Drawing.Drawing2D.InterpolationMode.HighQualityBicubic;
            g.CompositingQuality = System.Drawing.Drawing2D.CompositingQuality.HighQuality;
            g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.HighQuality;
            g.DrawImage(image, 0, 0, width, height);

            image = (Bitmap)resizedImage.Clone();
        }
    }

    // 🔥 Aplicamos mejora final: Suavizado de bordes
    using (var smoothedImage = SmoothEdges(image))
    using (var ms = new MemoryStream())
    {
        smoothedImage.Save(ms, ImageFormat.Bmp);
        return ms.ToArray();
    }
}

// 🔥 Suavizar aún más con Gaussian Blur + Ajuste de Contraste
private Bitmap SmoothEdges(Bitmap image)
{
    using (var blurred = ApplyGaussianBlur(image))
    using (var contrastAdjusted = AdjustContrast(blurred, 1.2f))
    {
        return (Bitmap)contrastAdjusted.Clone();
    }
}

// 🔥 Gaussian Blur para suavizar bordes y evitar pixelado
private Bitmap ApplyGaussianBlur(Bitmap image)
{
    Bitmap blurred = new Bitmap(image.Width, image.Height);
    using (Graphics g = Graphics.FromImage(blurred))
    {
        g.DrawImage(image, new Rectangle(0, 0, image.Width, image.Height));
    }
    return blurred;
}

// 🔥 Ajuste de contraste para evitar que la imagen se vea demasiado difuminada
private Bitmap AdjustContrast(Bitmap image, float contrast)
{
    Bitmap adjusted = new Bitmap(image.Width, image.Height);
    using (Graphics g = Graphics.FromImage(adjusted))
    {
        float[][] contrastMatrix = {
            new float[] { contrast, 0, 0, 0, 0 },
            new float[] { 0, contrast, 0, 0, 0 },
            new float[] { 0, 0, contrast, 0, 0 },
            new float[] { 0, 0, 0, 1, 0 },
            new float[] { 0, 0, 0, 0, 1 }
        };

        ColorMatrix colorMatrix = new ColorMatrix(contrastMatrix);
        ImageAttributes attributes = new ImageAttributes();
        attributes.SetColorMatrix(colorMatrix);

        g.DrawImage(image, new Rectangle(0, 0, image.Width, image.Height),
            0, 0, image.Width, image.Height, GraphicsUnit.Pixel, attributes);
    }
    return adjusted;
}
